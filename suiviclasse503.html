<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi 5√®me 3</title>
    <style>
        :root {
            --taupe-dark: #4A4440;
            --taupe-medium: #8C8279;
            --taupe-light: #E5E0DB;
            --taupe-bg: #F2EFED;
            --color-red: #ff6b6b;
            --color-green: #55efc4;
            --color-yellow: #ffd93d;
            --color-orange: #ff9f43;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: var(--taupe-light); padding: 10px; }
        .container { max-width: 1350px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); overflow: hidden; position: relative; }
        
        .header { background: var(--taupe-dark); color: white; padding: 15px; text-align: center; position: relative; }
        .logout-btn { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: 0.3s; }
        .logout-btn:hover { background: var(--color-red); border-color: transparent; }

        .tabs { display: flex; background: #3d3834; justify-content: center; }
        .tab-btn { padding: 12px 25px; border: none; background: none; color: #bbb; cursor: pointer; font-weight: bold; font-size: 14px; }
        .tab-btn.active { color: white; background: var(--taupe-medium); border-bottom: 3px solid var(--color-green); }

        .view-content { display: none; padding: 10px; }
        .view-content.active { display: block; }

        table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        th { 
    background: var(--taupe-medium); 
    color: white; 
    padding: 12px 4px;      /* Augmentation de l'espace vertical */
    font-size: 14px;        /* Taille de police augment√©e */
    text-transform: uppercase; 
    letter-spacing: 1px;    /* Un peu d'espace entre les lettres pour la clart√© */
}
        td { padding: 2px 4px; text-align: center; border-bottom: 1px solid #eee; height: 35px; }
        tbody tr:nth-child(even) { background-color: #fafafa; }
        td:first-child { font-weight: bold; color: var(--taupe-dark); text-align: left; padding-left: 10px; width: 150px; font-size: 15px; }
        
        .cell-container { display: flex; align-items: center; justify-content: center; gap: 4px; }
        .count-display { min-width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 13px; background: #fff; border: 1px solid #ccc; border-radius: 4px; }
        .count-display.active { color: white; border: none; }
        .count-display.retard.active { background: var(--color-red); }
        .count-display.travail.active { background: var(--color-yellow); color: #333; }
        .count-display.materiel.active { background: var(--color-orange); }
        .count-display.bavardage.active { background: #a29bfe; }
        .count-display.perturbation.active { background: #fd79a8; }

        .attitude-indicator { font-size: 22px; }
        .btn-plus { width: 24px; height: 24px; border: 1px solid #ddd; border-radius: 50px; cursor: pointer; background: #f5b8b8; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .btn-minus { width: 24px; height: 24px; border: 1px solid #ddd; border-radius: 50px; cursor: pointer; background: #a2f9ab; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        textarea { width: 100%; height: 80px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin-top: 10px; }

        #loginModal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; z-index: 3000; box-shadow: 0 0 50px rgba(0,0,0,0.3); width: 320px; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; }
        .save-indicator { position: fixed; top: 10px; right: 10px; background: var(--color-green); padding: 8px 15px; border-radius: 5px; display: none; z-index: 4000; color: white; }

        .note-item { margin-bottom: 10px; padding: 8px; background: #f9f9f9; border-left: 4px solid var(--taupe-medium); }
        .note-date { font-weight: bold; font-size: 11px; color: #666; }

        @media print {
            .tabs, .header, #overlay, #loginModal, .week-nav, .btn-print, .actions-bar, .btn-plus, .btn-minus, textarea, .logout-btn { display: none !important; }
            .container { box-shadow: none; border: none; }
            #view-stats { display: block !important; }
        }
    </style>
</head>
<body>

    <div id="overlay"></div>
    <div id="loginModal">
        <h2 style="text-align:center; margin-bottom:15px;">üîê Acc√®s Professeur 5√®me 3</h2>
        <input type="email" id="loginEmail" placeholder="Email" style="width:100%; padding:10px; margin-bottom:10px;">
        <input type="password" id="loginPassword" placeholder="Mot de passe" style="width:100%; padding:10px; margin-bottom:15px;">
        <button onclick="window.login()" style="width:100%; padding:12px; background:var(--taupe-dark); color:white; border:none; border-radius:5px; cursor:pointer;">Se connecter</button>
    </div>

    <div class="save-indicator" id="saveIndicator">‚úì Sauvegard√©</div>

    <div class="container" id="appContainer" style="display:none;">
        <div class="header">
            <h1>Suivi Classe 5√®me 3</h1>
            <button class="logout-btn" onclick="window.logout()">D√©connexion üö™</button>
        </div>

        <div class="tabs">
            <button class="tab-btn active" id="tab-saisie" onclick="window.switchTab('saisie')">üìù SAISIE HEBDO</button>
            <button class="tab-btn" id="tab-stats" onclick="window.switchTab('stats')">üìä BILAN & NOTES</button>
        </div>

        <div id="view-saisie" class="view-content active">
            <div class="week-nav" style="text-align:center; padding:10px; background:var(--taupe-bg); border-radius:5px; margin-bottom:10px;">
                <button onclick="window.changeWeek(-1)">‚óÄ Pr√©c√©dente</button>
                <span id="weekDisplay" style="font-weight:bold; margin:0 20px; font-size:16px;"></span>
                <button onclick="window.changeWeek(1)">Suivante ‚ñ∂</button>
            </div>
            <table>
                <thead>
                    <tr><th>üë®‚Äçüéì√âl√®ve</th><th>üï∞Ô∏èRetard</th><th>üììTravail</th><th>üìöOubli mat√©riel</th><th>üó£Ô∏èBavardages</th><th>üëøPerturbe le cours</th><th>üå°Ô∏èAttitude globale</th></tr>
                </thead>
                <tbody id="tableSaisie"></tbody>
            </table>
            <textarea id="weekNotes" placeholder="Notes de la semaine (incidents, progr√®s, rappels...)"></textarea>
        </div>

        <div id="view-stats" class="view-content">
            <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; background:var(--taupe-bg); margin-bottom:15px; border-radius:5px;">
                <h3 style="font-size:14px;">STATISTIQUES CUMUL√âES 5√®me 3</h3>
                <button onclick="window.print()" style="padding:8px 15px; cursor:pointer; background:var(--taupe-dark); color:white; border:none; border-radius:4px;">üñ®Ô∏è PDF</button>
            </div>
            <table>
                <thead>
                    <tr><th>√âl√®ve</th><th>Retards</th><th>Travail</th><th>Mat√©riel</th><th>Bavard.</th><th>Perturb.</th><th>Total</th></tr>
                </thead>
                <tbody id="tableStats"></tbody>
            </table>
            <div style="margin-top:20px; border-top:2px solid var(--taupe-dark); padding-top:15px;">
                <h3>Historique des notes hebdo</h3>
                <div id="notesContainer" style="margin-top:10px;"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // CONFIGURATION SP√âCIFIQUE 5√®me 3
        const firebaseConfig = {
            apiKey: "AIzaSyByXTbvU6F9UlO839bSmG1dgLvBMDfkK3A",
            authDomain: "suivi-5eme3.firebaseapp.com",
            projectId: "suivi-5eme3",
            storageBucket: "suivi-5eme3.firebasestorage.app",
            messagingSenderId: "96920713162",
            appId: "1:96920713162:web:5c606b0785f50c96978133"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // LISTE DES √âL√àVES 5√®me 3
        const eleves = ["Ed Jaad", "No√©mie", "Adam", "Badia", "Ad√®le", "Axel", "Jules", "Lorenzo", "R√©mi", "Giulia", "Eva", "Eline", "Kim", "Joseph", "Alexandre", "Esteban", "Gabriella", "Ehsan", "Paul", "Leny", "Veronika", "L√©o", "Sara", "Enola", "Enzo", "Quentin", "Mohamed"];
        
        const negCategories = ['retard', 'travail', 'materiel', 'bavardage', 'perturbation'];
        let currentWeekOffset = 0;
        let saveTimeout = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('overlay').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                initApp();
            } else {
                document.getElementById('appContainer').style.display = 'none';
                document.getElementById('loginModal').style.display = 'block';
                document.getElementById('overlay').style.display = 'block';
            }
        });

        window.login = async function() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            try { await signInWithEmailAndPassword(auth, email, password); } 
            catch (e) { alert("Acc√®s refus√© - V√©rifiez vos identifiants"); }
        };

        window.logout = async function() {
            if(confirm("Voulez-vous fermer votre session ?")) {
                await signOut(auth);
                location.reload();
            }
        };

        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.view-content').forEach(v => v.classList.remove('active'));
            if(tabName === 'saisie') document.getElementById('tab-saisie').classList.add('active');
            else { document.getElementById('tab-stats').classList.add('active'); loadStats(); }
            document.getElementById('view-' + tabName).classList.add('active');
        };

        function getWeekDates(offset) {
            const today = new Date(); today.setDate(today.getDate() + (offset * 7));
            const day = today.getDay();
            const diff = today.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(today.setDate(diff));
            const weekNum = Math.ceil((((monday - new Date(monday.getFullYear(), 0, 1)) / 86400000) + 1) / 7);
            return { weekNum, year: monday.getFullYear(), display: `Semaine ${weekNum} (${monday.getFullYear()})` };
        }

        window.changeWeek = async function(offset) {
            currentWeekOffset += offset;
            document.getElementById('weekDisplay').textContent = getWeekDates(currentWeekOffset).display;
            await loadWeekData();
        };

        function updateAttitude(eleve) {
            let total = 0;
            negCategories.forEach(cat => {
                const el = document.getElementById(`count-${eleve}-${cat}`);
                if(el) total += parseInt(el.textContent);
            });
            const indicator = document.getElementById(`attitude-${eleve}`);
            if(!indicator) return;
            if (total === 0) indicator.textContent = "üü¢";
            else if (total === 1) indicator.textContent = "üçè";
            else if (total === 2) indicator.textContent = "üü°";
            else if (total === 3) indicator.textContent = "üìí";
            else if (total === 4) indicator.textContent = "üü†";
            else if (total === 5) indicator.textContent = "üò°";
            else indicator.textContent = "üî¥";
        }

        window.changeCount = function(e, c, v) {
            const el = document.getElementById(`count-${e}-${c}`);
            let val = Math.max(0, parseInt(el.textContent) + v);
            el.textContent = val;
            el.classList.toggle('active', val > 0);
            updateAttitude(e);
            debounceSave();
        };

        function debounceSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveCurrentWeek, 1000);
        }

        async function saveCurrentWeek() {
            const week = getWeekDates(currentWeekOffset);
            const data = {};
            eleves.forEach(e => {
                negCategories.forEach(c => {
                    const el = document.getElementById(`count-${e}-${c}`);
                    data[`${e}_${c}`] = { count: el ? parseInt(el.textContent) : 0 };
                });
            });
            await setDoc(doc(db, 'weeks', `week_${week.year}_${week.weekNum}`), { 
                data, 
                notes: document.getElementById('weekNotes').value 
            });
            document.getElementById('saveIndicator').style.display = 'block';
            setTimeout(() => document.getElementById('saveIndicator').style.display = 'none', 1000);
        }

        async function loadWeekData() {
            const week = getWeekDates(currentWeekOffset);
            const snap = await getDoc(doc(db, 'weeks', `week_${week.year}_${week.weekNum}`));
            const data = snap.exists() ? snap.data().data : {};
            document.getElementById('weekNotes').value = snap.exists() ? (snap.data().notes || '') : '';
            eleves.forEach(e => {
                negCategories.forEach(c => {
                    const val = data[`${e}_${c}`]?.count || 0;
                    const el = document.getElementById(`count-${e}-${c}`);
                    if(el) { el.textContent = val; el.classList.toggle('active', val > 0); }
                });
                updateAttitude(e);
            });
        }

        async function loadStats() {
            const tbody = document.getElementById('tableStats');
            const notesCont = document.getElementById('notesContainer');
            tbody.innerHTML = '<tr><td colspan="7">Chargement...</td></tr>';
            const totals = {};
            eleves.forEach(e => { totals[e] = { r:0, t:0, m:0, b:0, p:0 }; });

            const snap = await getDocs(collection(db, "weeks"));
            notesCont.innerHTML = '';
            
            snap.forEach((doc) => {
                const wd = doc.data().data;
                const wn = doc.data().notes;
                const weekName = doc.id.replace('week_', 'Semaine ').replace('_', ' / ');

                eleves.forEach(e => {
                    if(wd[`${e}_retard`]) {
                        totals[e].r += wd[`${e}_retard`].count || 0;
                        totals[e].t += wd[`${e}_travail`].count || 0;
                        totals[e].m += wd[`${e}_materiel`].count || 0;
                        totals[e].b += wd[`${e}_bavardage`].count || 0;
                        totals[e].p += wd[`${e}_perturbation`].count || 0;
                    }
                });

                if (wn && wn.trim() !== "") {
                    notesCont.innerHTML += `<div class="note-item"><span class="note-date">${weekName}</span><p>${wn}</p></div>`;
                }
            });

            tbody.innerHTML = '';
            eleves.forEach(e => {
                const t = totals[e];
                const sum = t.r + t.t + t.m + t.b + t.p;
                tbody.innerHTML += `<tr><td>${e}</td><td>${t.r}</td><td>${t.t}</td><td>${t.m}</td><td>${t.b}</td><td>${t.p}</td>
                <td><span style="font-weight:bold; color:${sum >= 10 ? 'red' : 'black'}">${sum}</span></td></tr>`;
            });
        }

        function initTable() {
            const tbody = document.getElementById('tableSaisie');
            tbody.innerHTML = '';
            eleves.forEach(eleve => {
                const row = document.createElement('tr');
                let html = `<td>${eleve}</td>`;
                negCategories.forEach(cat => {
                    html += `<td><div class="cell-container">
                        <button class="btn-minus" onclick="window.changeCount('${eleve}', '${cat}', -1)">-</button>
                        <span class="count-display ${cat}" id="count-${eleve}-${cat}">0</span>
                        <button class="btn-plus" onclick="window.changeCount('${eleve}', '${cat}', 1)">+</button>
                    </div></td>`;
                });
                html += `<td><span class="attitude-indicator" id="attitude-${eleve}">üü¢</span></td>`;
                row.innerHTML = html;
                tbody.appendChild(row);
            });
        }

        async function initApp() {
            initTable();
            document.getElementById('weekDisplay').textContent = getWeekDates(0).display;
            await loadWeekData();
            document.getElementById('weekNotes').addEventListener('input', debounceSave);
        }
    </script>
</body>
</html>


