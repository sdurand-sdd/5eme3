<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi Classe 5ème 3</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --bg: #f4f7f6;
            --white: #ffffff;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--primary); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        header { background: var(--primary); color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .auth-card { background: white; padding: 2rem; border-radius: 12px; width: 300px; text-align: center; }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; transition: opacity 0.3s; }
        button:hover { opacity: 0.9; }
        .logout-btn { background: #e74c3c; font-size: 0.8rem; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { background: #ddd; color: var(--primary); font-weight: bold; }
        .tab-btn.active { background: var(--accent); color: white; }
        .student-card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: grid; grid-template-columns: 180px 1fr auto; align-items: center; gap: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .student-name { font-weight: bold; font-size: 1.1rem; }
        .counters { display: flex; gap: 15px; justify-content: center; }
        .counter-group { text-align: center; background: #f8f9fa; padding: 8px; border-radius: 8px; min-width: 80px; }
        .counter-label { font-size: 0.7rem; text-transform: uppercase; color: #7f8c8d; display: block; margin-bottom: 5px; }
        .btn-inc { background: #2ecc71; width: 25px; height: 25px; border-radius: 50%; padding: 0; line-height: 1; }
        .btn-dec { background: #e74c3c; width: 25px; height: 25px; border-radius: 50%; padding: 0; line-height: 1; margin-right: 5px; }
        .score-badge { font-size: 1.2rem; font-weight: bold; padding: 5px 15px; border-radius: 20px; min-width: 40px; text-align: center; }
        .status-saved { color: #2ecc71; font-size: 0.9rem; margin-top: 10px; display: none; }
        .history-table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; }
        .history-table th, .history-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .history-table th { background: #f8f9fa; }
        #page-app { display: none; }
    </style>
</head>
<body>

    <div id="auth-screen" class="auth-screen">
        <div class="auth-card">
            <h3>Suivi 5ème 3</h3>
            <p style="font-size: 0.8rem; color: #666;">Espace Équipe Pédagogique</p>
            <input type="email" id="email" placeholder="Email de l'équipe">
            <input type="password" id="password" placeholder="Mot de passe">
            <button onclick="handleLogin()">Se connecter</button>
            <p id="auth-error" style="color: red; font-size: 0.8rem; margin-top: 10px;"></p>
        </div>
    </div>

    <div id="page-app" class="container">
        <header>
            <div>
                <h1 style="margin:0; font-size: 1.5rem;">Classe 5ème 3</h1>
                <div id="save-status" class="status-saved">✓ Sauvegardé</div>
            </div>
            <button class="logout-btn" onclick="handleLogout()">Déconnexion</button>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('suivi')">Saisie du cours</button>
            <button class="tab-btn" onclick="showTab('bilan')">Bilan & Export</button>
        </div>

        <div id="tab-suivi">
            <div id="students-list"></div>
        </div>

        <div id="tab-bilan" style="display:none;">
            <button onclick="exportPDF()" style="margin-bottom: 20px; background: #27ae60;">Télécharger le Bilan PDF</button>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Élève</th>
                        <th>Retards</th>
                        <th>Oublis</th>
                        <th>Bavardages</th>
                        <th>Note Participation</th>
                    </tr>
                </thead>
                <tbody id="history-body"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        // CONFIGURATION COLLÈGUE (5ème 3)
        const firebaseConfig = {
            apiKey: "AIzaSyByXTbvU6F9UlO839bSmG1dgLvBMDfkK3A",
            authDomain: "suivi-5eme3.firebaseapp.com",
            projectId: "suivi-5eme3",
            storageBucket: "suivi-5eme3.firebasestorage.app",
            messagingSenderId: "96920713162",
            appId: "1:96920713162:web:5c606b0785f50c96978133"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // LISTE DES ÉLÈVES
        const eleves = ["Ed Jaad", "Noémie", "Adam", "Badia", "Adèle", "Axel", "Jules", "Lorenzo", "Rémi", "Giulia", "Eva", "Eline", "Kim", "Joseph", "Alexandre", "Esteban", "Gabriella", "Ehsan", "Paul", "Leny", "Veronika", "Léo", "Sara", "Enola", "Enzo", "Quentin", "Mohamed"];

        let currentData = {};
        const weekKey = `week_${new Date().getFullYear()}_${getWeekNumber(new Date())}`;

        // AUTHENTIFICATION
        window.handleLogin = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) {
                document.getElementById('auth-error').innerText = "Erreur de connexion";
            }
        };

        window.handleLogout = () => signOut(auth);

        onAuthStateChanged(auth, user => {
            if (user) {
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('page-app').style.display = 'block';
                initRealtimeData();
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('page-app').style.display = 'none';
            }
        });

        // SYNCHRO FIREBASE
        function initRealtimeData() {
            onSnapshot(doc(db, 'suivi', weekKey), (doc) => {
                currentData = doc.exists() ? doc.data() : {};
                renderStudents();
                renderHistory();
            });
        }

        async function saveData() {
            const status = document.getElementById('save-status');
            status.style.display = 'block';
            await setDoc(doc(db, 'suivi', weekKey), currentData);
            setTimeout(() => status.style.display = 'none', 2000);
        }

        // LOGIQUE MÉTIER
        function getScore(name) {
            const d = currentData[name] || { r: 0, o: 0, b: 0 };
            return Math.max(0, 20 - (d.r * 2) - (d.o * 2) - (d.b * 1));
        }

        window.updateVal = (name, field, delta) => {
            if (!currentData[name]) currentData[name] = { r: 0, o: 0, b: 0 };
            currentData[name][field] = Math.max(0, currentData[name][field] + delta);
            saveData();
        };

        // RENDER
        function renderStudents() {
            const list = document.getElementById('students-list');
            list.innerHTML = eleves.map(name => {
                const d = currentData[name] || { r: 0, o: 0, b: 0 };
                const score = getScore(name);
                let color = "#2ecc71";
                if(score < 16) color = "#f1c40f";
                if(score < 12) color = "#e67e22";
                if(score < 8) color = "#e74c3c";

                return `
                    <div class="student-card">
                        <div class="student-name">${name}</div>
                        <div class="counters">
                            <div class="counter-group">
                                <span class="counter-label">Retards</span>
                                <button class="btn-dec" onclick="updateVal('${name}','r',-1)">-</button>
                                <strong>${d.r}</strong>
                                <button class="btn-inc" onclick="updateVal('${name}','r',1)">+</button>
                            </div>
                            <div class="counter-group">
                                <span class="counter-label">Oublis</span>
                                <button class="btn-dec" onclick="updateVal('${name}','o',-1)">-</button>
                                <strong>${d.o}</strong>
                                <button class="btn-inc" onclick="updateVal('${name}','o',1)">+</button>
                            </div>
                            <div class="counter-group">
                                <span class="counter-label">Bavard.</span>
                                <button class="btn-dec" onclick="updateVal('${name}','b',-1)">-</button>
                                <strong>${d.b}</strong>
                                <button class="btn-inc" onclick="updateVal('${name}','b',1)">+</button>
                            </div>
                        </div>
                        <div class="score-badge" style="background: ${color}22; color: ${color}">${score}/20</div>
                    </div>
                `;
            }).join('');
        }

        function renderHistory() {
            const body = document.getElementById('history-body');
            body.innerHTML = eleves.map(name => {
                const d = currentData[name] || { r: 0, o: 0, b: 0 };
                return `<tr><td>${name}</td><td>${d.r}</td><td>${d.o}</td><td>${d.b}</td><td><strong>${getScore(name)}/20</strong></td></tr>`;
            }).join('');
        }

        // NAVIGATION
        window.showTab = (tab) => {
            document.getElementById('tab-suivi').style.display = tab === 'suivi' ? 'block' : 'none';
            document.getElementById('tab-bilan').style.display = tab === 'bilan' ? 'block' : 'none';
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        };

        // EXPORT PDF
        window.exportPDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(`Bilan Suivi Classe 5ème 3 - Semaine ${getWeekNumber(new Date())}`, 14, 15);
            doc.autoTable({
                startY: 25,
                head: [['Élève', 'Retards', 'Oublis', 'Bavardages', 'Note']],
                body: eleves.map(n => {
                    const d = currentData[n] || { r: 0, o: 0, b: 0 };
                    return [n, d.r, d.o, d.b, getScore(n) + "/20"];
                })
            });
            doc.save(`Bilan_503_Semaine_${getWeekNumber(new Date())}.pdf`);
        };

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            return Math.ceil((((d - new Date(Date.UTC(d.getUTCFullYear(), 0, 1))) / 86400000) + 1) / 7);
        }
    </script>
</body>
</html>